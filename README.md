# Проект анализа и оптимизации нейросетей для анализа тональности

Этот проект предоставляет утилиты для анализа и оптимизации нейросетей, предназначенных для анализа тональности текстов (на примере набора данных IMDB). Основной файл `optimize_model.py` позволяет анализировать характеристики моделей в форматах `.pth` и `.onnx`, а также квантизовать их с использованием различных методов.

## Структура проекта
```
├── src/
│   ├── data.py       # Загрузка и предобработка данных IMDB
│   ├── model.py      # Определение модели SentimentNet
│   └── train.py      # Обучение модели SentimentNet
├── optimize_model.py # Анализ и квантизация моделей
├── IMDB Dataset.csv  # Пример набора данных (не включен в репозиторий)
└── README.md         # Этот файл
```

### Описание файлов

- **`src/data.py`**:  
  Содержит класс `IMDBDataset` и функции для загрузки данных из CSV-файла, их векторизации с помощью `TfidfVectorizer` и создания `DataLoader` для обучения и тестирования.

- **`src/model.py`**:  
  Определяет класс `SentimentNet` — простую нейросеть для анализа тональности с двумя линейными слоями.

- **`src/train.py`**:  
  Реализует обучение модели `SentimentNet` на данных IMDB и сохранение обученной модели в файл `.pth`.

- **`optimize_model.py`**:  
  Основной скрипт для анализа и квантизации моделей. Поддерживает:
  - Анализ характеристик моделей `.pth` и `.onnx` (веса, размеры, типы данных).
  - Квантизацию `.pth` методами `dynamic`, `static`, `qat`.
  - Квантизацию `.onnx` методами `dynamic`, `static`.

- **`IMDB Dataset.csv`**:  
  Ожидаемый файл с данными (не включен). Должен содержать колонки `review` (текст отзыва) и `sentiment` (метка: `positive` или `negative`).

## Установка

1. Установите зависимости:
   ```bash
   pip install torch pandas scikit-learn numpy onnx onnxruntime
   ```

2. Убедитесь, что у вас есть файл IMDB Dataset.csv в корневой папке или укажите путь к нему в скриптах.

## Использование

### 1. Обучение модели

Используйте `src/train.py` для обучения модели:
    ```bash
    python src/train.py
    ```

- Аргументы по умолчанию:
  - file_path="IMDB Dataset.csv"
  - model_path="sentiment_model.pth"
  - epochs=10
  - batch_size=32
  - max_samples=50000
  - max_features=5000

После выполнения модель сохранится в файл `sentiment_model.pth`.

### 2. Анализ модели

Используйте `optimize_model.py` для анализа характеристик модели:
 ```bash
   python optimize_model.py
   ```
- Пример ввода:
    ```text
    Введите тип модели (pth или onnx): pth
    Введите путь к модели: sentiment_model.pth
    Выберите действие (анализ или квантизация): анализ
    ```

- Пример вывода:
    ```text
    Анализ модели: sentiment_model.pth
    Parameter: fc1.weight, Shape: torch.Size([128, 5000]), Data Type: torch.float32
    Parameter: fc1.bias, Shape: torch.Size([128]), Data Type: torch.float32
    Parameter: fc2.weight, Shape: torch.Size([1, 128]), Data Type: torch.float32
    Parameter: fc2.bias, Shape: torch.Size([1]), Data Type: torch.float32
    Общее количество параметров: 640641
    Общий размер модели: 2.44 MB
    Модель не квантизована
    ```
  
### 3. Квантизация модели
Для `.pth` <br>
Поддерживаются методы: `dynamic`, `static`, `qat`.
- Пример с методом QAT:
    ```text
    Введите тип модели (pth или onnx): pth
    Введите путь к модели: sentiment_model.pth
    Выберите действие (анализ или квантизация): квантизация
    Введите размерность входных данных (например, 5000): 5000
    Выберите метод квантизации (dynamic, static, qat): qat
    Введите путь для сохранения квантизованной модели: quant_model_with_qat.pth
    ```

Метод QAT требует переобучения модели с использованием train_loader, который загружается из `src/data.py`.

Для `.onnx` <br>
Поддерживаются методы: `dynamic`, `static`.
- Пример с методом static:
    ```text
    Введите тип модели (pth или onnx): onnx
    Введите путь к модели: sentiment_model.onnx
    Выберите действие (анализ или квантизация): квантизация
    Выберите метод квантизации (dynamic, static): static
    Введите путь для сохранения квантизованной модели: quant_model_with_static.onnx
    ```
  Метод `static` требует калибровочных данных, которые загружаются из `IMDB Dataset.csv`.

Примечания
- QAT для .pth: Требует обучающих данных и переобучения. Убедитесь, что IMDB Dataset.csv доступен.
- Ошибки: Если модель уже квантизована, скрипт сообщит об этом и выведет ее характеристики.
- Static для .onnx: Требует калибровочных данных. Имя входа модели должно быть 'input', иначе настройте ONNXCalibrationDataReader.